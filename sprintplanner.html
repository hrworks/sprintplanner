<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Phase Gantt Chart Editor with CRDT Sync</title>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --text-primary: #eee;
            --text-secondary: #888;
            --accent: #e94560;
            --accent-hover: #ff6b6b;
            --accent-secondary: #00d9ff;
            --border: #0f3460;
            --row-height: 45px;
            --bar-height: 32px;
        }

        body.light-mode {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8e8e8;
            --text-primary: #333;
            --text-secondary: #666;
            --accent: #e94560;
            --accent-hover: #ff6b6b;
            --accent-secondary: #0088aa;
            --border: #ddd;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 380px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--bg-primary);
        }

        .sidebar-header h2 {
            color: var(--accent);
            margin-bottom: 10px;
            font-size: 18px;
        }

        .current-file-info {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            padding: 5px 8px;
            background: var(--bg-primary);
            border-radius: 4px;
        }

        .sync-status {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: none;
        }

        .sync-status.connected {
            display: block;
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }

        .sync-status.connecting {
            display: block;
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .sync-status.disconnected {
            display: block;
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--accent);
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
        }

        .btn-success {
            background: var(--accent-secondary);
            color: var(--bg-primary);
        }

        .btn-success:hover {
            opacity: 0.8;
        }

        .btn-warning {
            background: #ffc107;
            color: #1a1a2e;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 11px;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .theme-toggle label {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-tertiary);
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: var(--accent);
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
            background: #ffc107;
        }

        .project-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .project-item {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .project-item:hover {
            border-color: var(--accent);
        }

        .project-item.selected {
            border-color: var(--accent-secondary);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
        }

        .project-item.drag-over {
            border-color: var(--accent);
            border-style: dashed;
            background: rgba(233, 69, 96, 0.1);
        }

        .project-item.dragging {
            opacity: 0.5;
        }

        .project-header {
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: var(--bg-tertiary);
        }

        .project-drag-handle {
            cursor: grab;
            padding: 5px;
            color: var(--text-secondary);
            font-size: 14px;
            margin-right: 8px;
        }

        .project-drag-handle:active {
            cursor: grabbing;
        }

        .project-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 13px;
        }

        .project-category {
            font-size: 10px;
            margin-top: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .project-color-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .project-actions {
            display: flex;
            gap: 5px;
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            font-size: 14px;
            transition: color 0.3s;
        }

        .icon-btn:hover {
            color: var(--accent);
        }

        .phase-list {
            padding: 10px 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            display: none;
        }

        .phase-list.expanded {
            max-height: 1000px;
            display: block;
        }

        .accordion-toggle {
            font-size: 12px;
            transition: transform 0.3s;
            display: inline-block;
        }

        .accordion-toggle.expanded {
            transform: rotate(90deg);
        }

        .phase-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border-radius: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .phase-item:hover {
            opacity: 0.8;
        }

        .phase-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .phase-info {
            flex: 1;
            min-width: 0;
        }

        .phase-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .phase-dates {
            font-size: 10px;
            color: var(--text-secondary);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
        }

        .toolbar {
            padding: 12px 20px;
            background: var(--bg-tertiary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--bg-primary);
            flex-wrap: wrap;
            gap: 10px;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-primary);
            padding: 6px 12px;
            border-radius: 5px;
        }

        .toolbar-group label {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .zoom-slider {
            width: 80px;
            accent-color: var(--accent);
        }

        .date-input {
            background: var(--bg-tertiary);
            border: 1px solid var(--bg-primary);
            color: var(--text-primary);
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 11px;
            width: 130px;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .nav-buttons {
            display: flex;
            gap: 5px;
        }

        .nav-btn {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .gantt-outer-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .gantt-scroll-container {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        .gantt-wrapper {
            display: flex;
            min-width: max-content;
        }

        .gantt-labels {
            width: 220px;
            flex-shrink: 0;
            background: var(--bg-secondary);
            border-right: 2px solid var(--accent);
            position: sticky;
            left: 0;
            z-index: 20;
        }

        .gantt-label-header {
            height: 50px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--bg-primary);
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-weight: 600;
            font-size: 12px;
            position: sticky;
            top: 0;
            z-index: 25;
        }

        .gantt-label-row {
            height: var(--row-height);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.3s;
            gap: 6px;
            position: relative;
        }

        .gantt-label-row:hover {
            background: var(--bg-tertiary);
        }

        .gantt-label-row.selected {
            background: var(--bg-tertiary);
            border-left: 3px solid var(--accent-secondary);
        }

        .label-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status-icon {
            font-size: 14px;
            flex-shrink: 0;
            cursor: help;
            position: relative;
        }

        .status-tooltip {
            display: none;
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 11px;
            color: var(--text-primary);
            white-space: pre-wrap;
            max-width: 250px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            margin-left: 10px;
        }

        .status-icon:hover .status-tooltip {
            display: block;
        }

        .project-link-icon {
            color: var(--accent-secondary);
            text-decoration: none;
            font-size: 12px;
            flex-shrink: 0;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .project-link-icon:hover {
            opacity: 1;
        }

        .category-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            white-space: nowrap;
            color: white;
            flex-shrink: 0;
        }

        .gantt-chart {
            flex: 1;
            position: relative;
        }

        .gantt-header {
            height: 50px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--bg-primary);
            display: flex;
            position: sticky;
            top: 0;
            z-index: 15;
        }

        .gantt-header-month {
            border-right: 1px solid var(--bg-primary);
            text-align: center;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .month-name {
            padding: 5px 8px;
            font-weight: 600;
            font-size: 11px;
            border-bottom: 1px solid var(--bg-primary);
            white-space: nowrap;
        }

        .day-row {
            display: flex;
            flex: 1;
        }

        .day-cell {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            color: var(--text-secondary);
            border-right: 1px solid var(--border);
            min-width: 0;
        }

        .day-cell.weekend {
            background: rgba(233, 69, 96, 0.1);
        }

        .day-cell.today {
            background: rgba(233, 69, 96, 0.3);
            color: var(--text-primary);
            font-weight: bold;
        }

        .gantt-body {
            position: relative;
        }

        .gantt-row {
            height: var(--row-height);
            border-bottom: 1px solid var(--border);
            position: relative;
            cursor: crosshair;
        }

        .gantt-row:nth-child(even) {
            background: rgba(15, 52, 96, 0.15);
        }

        body.light-mode .gantt-row:nth-child(even) {
            background: rgba(0, 0, 0, 0.03);
        }

        .gantt-row:hover {
            background: rgba(233, 69, 96, 0.05);
        }

        .gantt-grid-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            background: var(--border);
            pointer-events: none;
        }

        .gantt-grid-line.month {
            background: var(--border);
            width: 2px;
        }

        .milestone-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            pointer-events: none;
            z-index: 4;
        }

        .milestone-line.start-line {
            background: #4ade80;
        }

        .milestone-line.end-line {
            background: #f97316;
        }

        .phase-bar {
            position: absolute;
            border-radius: 4px;
            cursor: move;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 10px;
            font-weight: 500;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            overflow: hidden;
            transition: box-shadow 0.2s, transform 0.1s;
            min-width: 20px;
            z-index: 10;
        }

        .phase-bar-content {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .phase-bar-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
        }

        .phase-bar-subtitle {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 9px;
            opacity: 0.85;
            line-height: 1.2;
        }

        .phase-bar-link {
            color: white;
            text-decoration: none;
            font-size: 11px;
            opacity: 0.8;
            flex-shrink: 0;
            margin-left: 5px;
            transition: opacity 0.2s;
            padding: 4px 6px;
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
            z-index: 100;
			margin-botton: 0px
        }

        .phase-bar-link:hover {
            opacity: 1;
            background: rgba(0,0,0,0.4);
        }

        .phase-bar:hover {
            box-shadow: 0 0 12px rgba(255,255,255,0.4);
            z-index: 100;
            transform: scaleY(1.05);
        }

        .phase-bar.dragging {
            opacity: 0.9;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }

        .phase-bar.selected {
            box-shadow: 0 0 0 2px #fff, 0 0 15px rgba(0, 217, 255, 0.5);
        }

        .phase-bar .resize-handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 10px;
            cursor: ew-resize;
            background: transparent;
        }

        .phase-bar .resize-handle:hover {
            background: rgba(255,255,255,0.2);
        }

        .phase-bar .resize-handle.left {
            left: 0;
            border-radius: 4px 0 0 4px;
        }

        .phase-bar .resize-handle.right {
            right: 0;
            border-radius: 0 4px 4px 0;
        }

        .create-preview {
            position: absolute;
            border-radius: 4px;
            background: rgba(0, 217, 255, 0.4);
            border: 2px dashed var(--accent-secondary);
            pointer-events: none;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--text-primary);
        }

        .phase-connector {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--accent-secondary);
            border: 2px solid #fff;
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
            cursor: crosshair;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 200;
        }

        .phase-connector.left { left: -6px; }
        .phase-connector.right { right: -6px; }

        .phase-bar:hover .phase-connector { opacity: 1; }

        .phase-connector:hover {
            background: var(--accent);
            transform: translateY(-50%) scale(1.3);
        }

        .connection-svg {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 5;
        }

        .connection-line {
            fill: none;
            stroke: var(--accent-secondary);
            stroke-width: 2;
            opacity: 0.7;
            pointer-events: stroke;
            cursor: pointer;
        }

        .connection-line:hover {
            stroke-width: 4;
            opacity: 1;
        }

        .connection-delete {
            display: none;
        }

        .connection-preview {
            fill: none;
            stroke: var(--accent);
            stroke-width: 2;
            stroke-dasharray: 5,5;
        }

        .today-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--accent);
            z-index: 5;
            pointer-events: none;
        }

        .today-marker {
            position: absolute;
            top: 5px;
            transform: translateX(-50%);
            background: var(--accent);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            white-space: nowrap;
            z-index: 100;
        }

        .detail-panel {
            width: 320px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
        }

        .detail-panel.hidden {
            display: none;
        }

        .detail-header {
            padding: 15px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--bg-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-header h3 {
            color: var(--accent);
            font-size: 13px;
        }

        .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .form-control {
            width: 100%;
            padding: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 12px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 60px;
        }

        textarea.form-control.auto-grow {
            min-height: 80px;
            max-height: 200px;
            overflow-y: auto;
        }

        .color-picker {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 26px;
            height: 26px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-option:hover,
        .color-option.selected {
            border-color: var(--text-primary);
            transform: scale(1.15);
        }

        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .checkbox-label input[type="checkbox"] {
            accent-color: var(--accent);
            width: 16px;
            height: 16px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 10px;
            width: 500px;
            max-width: 90%;
            max-height: 80vh;
            overflow: hidden;
        }

        .modal-header {
            padding: 15px 20px;
            background: var(--bg-tertiary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            color: var(--accent);
            font-size: 14px;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: 55vh;
        }

        .modal-footer {
            padding: 12px 20px;
            background: var(--bg-tertiary);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .json-preview {
            background: var(--bg-primary);
            padding: 12px;
            border-radius: 5px;
            font-family: 'Consolas', monospace;
            font-size: 10px;
            white-space: pre-wrap;
            max-height: 250px;
            overflow: auto;
            color: var(--accent-secondary);
        }

        .file-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-item:hover {
            border-color: var(--accent);
            background: var(--bg-tertiary);
        }

        .file-item.selected {
            border-color: var(--accent-secondary);
            background: var(--bg-tertiary);
        }

        .file-info h4 {
            font-size: 13px;
            margin-bottom: 4px;
        }

        .file-info span {
            font-size: 10px;
            color: var(--text-secondary);
        }

        .file-actions {
            display: flex;
            gap: 5px;
        }

        .minimap {
            height: 40px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--bg-primary);
            position: relative;
            cursor: pointer;
        }

        .minimap-viewport {
            position: absolute;
            top: 2px;
            bottom: 2px;
            background: rgba(233, 69, 96, 0.3);
            border: 1px solid var(--accent);
            border-radius: 3px;
            cursor: grab;
        }

        .minimap-viewport:active {
            cursor: grabbing;
        }

        .minimap-bar {
            position: absolute;
            height: 4px;
            border-radius: 2px;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        ::-webkit-scrollbar-corner {
            background: var(--bg-primary);
        }

        .file-input {
            display: none;
        }

        .keyboard-hint {
            position: fixed;
            bottom: 50px;
            right: 20px;
            background: var(--bg-tertiary);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 11px;
            color: var(--text-secondary);
            z-index: 100;
            line-height: 1.8;
            opacity: 0.9;
        }

        .keyboard-hint kbd {
            background: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 3px;
            color: var(--text-primary);
            margin: 0 2px;
        }

        .keyboard-hint .hint-row {
            display: flex;
            gap: 10px;
        }

        .status-select {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .status-option {
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            background: var(--bg-tertiary);
            transition: all 0.2s;
            font-size: 12px;
        }

        .status-option:hover,
        .status-option.selected {
            border-color: var(--text-primary);
        }

        .channel-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .channel-input-group {
            display: flex;
            gap: 8px;
        }

        .channel-input-group input {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>üóìÔ∏è Roadmap Planer</h2>
                <div class="current-file-info" id="currentFileInfo">Keine Datei geladen</div>
                <div class="sync-status" id="syncStatus"></div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="addProject()">+ Projekt</button>
                    <button class="btn btn-secondary" onclick="showLoadDialog()">üìÇ Laden</button>
                    <button class="btn btn-secondary" onclick="showSaveDialog()">üíæ Speichern</button>
                </div>
                <div class="btn-group" style="margin-top: 8px;">
                    <button class="btn btn-success" onclick="exportJSON()">Export</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import</button>
                    <button class="btn btn-secondary" onclick="copyShareLink()" title="Link zum Teilen kopieren">üìã Link</button>
                    <input type="file" id="importFile" class="file-input" accept=".json" onchange="importJSON(event)">
                </div>
                <div class="theme-toggle">
                    <label>üåô Dark</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                        <span class="toggle-slider"></span>
                    </label>
                    <label>‚òÄÔ∏è Light</label>
                </div>
            </div>
            <div class="project-list" id="projectList"></div>
        </div>

        <div class="main-content">
            <div class="toolbar">
                <div class="toolbar-left">
                    <div class="toolbar-group">
                        <label>Von:</label>
                        <input type="date" class="date-input" id="startDate">
                        <label>Bis:</label>
                        <input type="date" class="date-input" id="endDate">
                        <button class="nav-btn" onclick="applyDateRange()" style="padding: 4px 8px;">‚úì</button>
                    </div>
                    <div class="toolbar-group">
                        <label>Zoom:</label>
                        <input type="range" class="zoom-slider" id="zoomSlider" min="2" max="60" value="20" oninput="updateZoom()">
                        <span id="zoomValue" style="font-size:11px;color:var(--text-secondary);width:35px;">20px</span>
                    </div>
                    <div class="toolbar-group">
                        <label>H√∂he:</label>
                        <input type="range" class="zoom-slider" id="heightSlider" min="45" max="90" value="45" oninput="updateRowHeight()">
                        <span id="heightValue" style="font-size:11px;color:var(--text-secondary);width:35px;">45px</span>
                    </div>
                    <div class="toolbar-group">
                        <label class="checkbox-label" style="margin:0;">
                            <input type="checkbox" id="showConnectionsCheckbox" checked onchange="toggleConnections()">
                            Verbindungen
                        </label>
                    </div>
                    <div class="nav-buttons">
                        <button class="nav-btn" onclick="scrollToToday()">üìç Heute</button>
                        <button class="nav-btn" onclick="scrollByAmount(-300)">‚óÄ</button>
                        <button class="nav-btn" onclick="scrollByAmount(300)">‚ñ∂</button>
                    </div>
                </div>
                <div>
                    <button class="btn btn-warning btn-small" onclick="toggleDetailPanel()">Details ‚ò∞</button>
                </div>
            </div>
            
            <div class="gantt-outer-container">
                <div class="gantt-scroll-container" id="ganttScrollContainer">
                    <div class="gantt-wrapper">
                        <div class="gantt-labels" id="ganttLabels"></div>
                        <div class="gantt-chart" id="ganttChart"></div>
                    </div>
                </div>
                <div class="minimap" id="minimap">
                    <div class="minimap-viewport" id="minimapViewport"></div>
                </div>
            </div>
        </div>

        <div class="detail-panel hidden" id="detailPanel">
            <div class="detail-header">
                <h3>Phase bearbeiten</h3>
                <button class="icon-btn" onclick="toggleDetailPanel()">‚úï</button>
            </div>
            <div class="detail-content" id="detailContent">
                <p style="color: var(--text-secondary); text-align: center; margin-top: 50px;">W√§hlen Sie eine Phase aus</p>
            </div>
        </div>
    </div>

    <div class="modal-overlay hidden" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Modal</h3>
                <button class="icon-btn" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <div class="keyboard-hint" id="keyboardHint">
        <button class="icon-btn" onclick="document.getElementById('keyboardHint').style.display='none'" style="position:absolute;top:2px;right:2px;font-size:12px;">‚úï</button>
        <div class="hint-row"><kbd>Scroll</kbd> X-Achse navigieren</div>
        <div class="hint-row"><kbd>Drag</kbd> auf Zeile = Neue Phase erstellen</div>
        <div class="hint-row"><kbd>Drag</kbd> auf Phase = Verschieben (auch zwischen Projekten)</div>
        <div class="hint-row"><kbd>Strg</kbd>+<kbd>Drag</kbd> = Phase kopieren</div>
    </div>

    <script>
        function generateId(prefix = '') {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let id = '';
            for (let i = 0; i < 6; i++) {
                id += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return prefix ? `${prefix}-${id}` : id;
        }

        let data = {
            projects: [],
            connections: [],
            viewStart: null,
            viewEnd: null,
            _lastUpdated: Date.now()
        };

        let currentFileId = null;
        let currentChannel = null;
        let syncPeers = new Map();
        let broadcastChannel = null;
        let eventSource = null;
        const SYNC_URL = 'sync.php';

        const defaultColors = [
            '#e94560', '#00d9ff', '#ffc107', '#4ade80', '#8b5cf6',
            '#f97316', '#06b6d4', '#ec4899', '#84cc16', '#a855f7',
            '#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#6366f1'
        ];

        const statusIcons = {
            'ok': '‚úÖ',
            'warning': '‚ö†Ô∏è',
            'delay': 'üî¥',
            'complete': 'üèÅ',
            '': ''
        };

        let selectedProject = null;
        let selectedPhase = null;
        let dayWidth = 20;
        let rowHeight = 45;
        let dragState = null;
        let createState = null;
        let minimapDragState = null;
        let chartStartDate = null;
        let chartEndDate = null;
        let expandedProjects = new Set();
        let projectDragState = null;
        let connectionDragState = null;
        let showConnections = true;
        const DRAG_THRESHOLD = 5;

        const STORAGE_KEY_FILES = 'ganttFiles';
        const STORAGE_KEY_SETTINGS = 'ganttSettings';

        function getStoredFiles() {
            try {
                const files = localStorage.getItem(STORAGE_KEY_FILES);
                return files ? JSON.parse(files) : {};
            } catch (e) {
                console.error('Error loading files:', e);
                return {};
            }
        }

        function saveFile(fileId, title, fileData) {
            const files = getStoredFiles();
            files[fileId] = {
                id: fileId,
                title: title,
                lastUpdated: Date.now(),
                data: fileData
            };
            localStorage.setItem(STORAGE_KEY_FILES, JSON.stringify(files));
            updateCurrentFileInfo(title, files[fileId].lastUpdated);
        }

        function loadFile(fileId) {
            const files = getStoredFiles();
            if (files[fileId]) {
                return files[fileId];
            }
            return null;
        }

        function deleteFile(fileId) {
            const files = getStoredFiles();
            delete files[fileId];
            localStorage.setItem(STORAGE_KEY_FILES, JSON.stringify(files));
        }

        function updateCurrentFileInfo(title, lastUpdated) {
            const info = document.getElementById('currentFileInfo');
            if (title) {
                const date = new Date(lastUpdated);
                const dateStr = date.toLocaleDateString('de-DE') + ' ' + date.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
                info.textContent = `üìÑ ${title} (${dateStr})`;
            } else {
                info.textContent = 'Keine Datei geladen';
            }
        }

        function saveSettings() {
            const settings = {
                theme: document.body.classList.contains('light-mode') ? 'light' : 'dark',
                zoom: dayWidth,
                rowHeight: rowHeight
            };
            localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings));
        }

        function loadSettings() {
            try {
                const settings = localStorage.getItem(STORAGE_KEY_SETTINGS);
                if (settings) {
                    const parsed = JSON.parse(settings);
                    if (parsed.theme === 'light') {
                        document.body.classList.add('light-mode');
                        document.getElementById('themeToggle').checked = true;
                    }
                    if (parsed.zoom) {
                        dayWidth = parsed.zoom;
                        document.getElementById('zoomSlider').value = dayWidth;
                        document.getElementById('zoomValue').textContent = dayWidth + 'px';
                    }
                    if (parsed.rowHeight) {
                        rowHeight = parsed.rowHeight;
                        document.getElementById('heightSlider').value = rowHeight;
                        document.getElementById('heightValue').textContent = rowHeight + 'px';
                        document.documentElement.style.setProperty('--row-height', rowHeight + 'px');
                        document.documentElement.style.setProperty('--bar-height', (rowHeight - 13) + 'px');
                    }
                }
            } catch (e) {
                console.error('Error loading settings:', e);
            }
        }

        function autoSave() {
            if (currentFileId) {
                const files = getStoredFiles();
                if (files[currentFileId]) {
                    saveFile(currentFileId, files[currentFileId].title, data);
                }
            }
            broadcastData();
        }

        function initSync(channel) {
            currentChannel = channel;
            
            // Close existing connections
            if (broadcastChannel) broadcastChannel.close();
            if (eventSource) eventSource.close();
            
            // Try PHP server first, fallback to BroadcastChannel
            eventSource = new EventSource(`${SYNC_URL}?channel=${channel}&action=stream`);
            
            eventSource.onopen = () => {
                updateSyncStatus('connected', `Verbunden: ${channel}`);
                // Request initial data
                fetch(`${SYNC_URL}?channel=${channel}&action=pull`)
                    .then(r => r.json())
                    .then(d => { if (d.projects) { data = d; ensureIds(); applyStoredDateRange(); renderProjectList(); updateGantt(); }});
            };
            
            eventSource.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'update' && msg.data?.projects) {
                        mergeData(msg.data);
                    }
                } catch(e) {}
            };
            
            eventSource.onerror = () => {
                // Fallback to BroadcastChannel for same-browser sync
                eventSource.close();
                eventSource = null;
                broadcastChannel = new BroadcastChannel('gantt-sync-' + channel);
                broadcastChannel.onmessage = (event) => handleSyncMessage(event.data);
                updateSyncStatus('connecting', `Lokal: ${channel}`);
                setTimeout(() => broadcastChannel.postMessage({ type: 'request-data', senderId: getOrCreatePeerId() }), 500);
            };
        }

        function getOrCreatePeerId() {
            let peerId = sessionStorage.getItem('ganttPeerId');
            if (!peerId) {
                peerId = generateId('peer');
                sessionStorage.setItem('ganttPeerId', peerId);
            }
            return peerId;
        }

        function handleSyncMessage(message) {
            switch (message.type) {
                case 'request-data':
                    if (data.projects.length > 0) {
                        broadcastChannel.postMessage({
                            type: 'full-sync',
                            data: data,
                            senderId: getOrCreatePeerId()
                        });
                    }
                    break;
                    
                case 'full-sync':
                    if (message.senderId !== getOrCreatePeerId()) {
                        if (data.projects.length === 0 || message.data._lastUpdated > data._lastUpdated) {
                            data = message.data;
                            renderProjectList();
                            updateGantt();
                        }
                    }
                    break;
                    
                case 'update':
                    if (message.senderId !== getOrCreatePeerId()) {
                        mergeData(message.data);
                    }
                    break;
            }
        }

        function mergeData(incomingData) {
            const existingProjectMap = new Map(data.projects.map(p => [p._id, p]));
            
            for (const incomingProject of incomingData.projects) {
                const existingProject = existingProjectMap.get(incomingProject._id);
                
                if (!existingProject) {
                    data.projects.push(incomingProject);
                } else {
                    const fields = ['name', 'category', 'link', 'status', 'color', 'description'];
                    for (const field of fields) {
                        if (incomingProject[field] !== undefined) {
                            const incomingTime = incomingProject._fieldUpdates?.[field] || 0;
                            const existingTime = existingProject._fieldUpdates?.[field] || 0;
                            if (incomingTime > existingTime) {
                                existingProject[field] = incomingProject[field];
                                existingProject._fieldUpdates = existingProject._fieldUpdates || {};
                                existingProject._fieldUpdates[field] = incomingTime;
                            }
                        }
                    }
                    
                    const existingPhaseMap = new Map(existingProject.phases.map(ph => [ph._id, ph]));
                    
                    for (const incomingPhase of incomingProject.phases) {
                        const existingPhase = existingPhaseMap.get(incomingPhase._id);
                        
                        if (!existingPhase) {
                            existingProject.phases.push(incomingPhase);
                        } else {
                            const phaseFields = ['name', 'subtitle', 'description', 'link', 'start', 'end', 'color', 'showStartLine', 'showEndLine'];
                            for (const field of phaseFields) {
                                if (incomingPhase[field] !== undefined) {
                                    const incomingTime = incomingPhase._fieldUpdates?.[field] || 0;
                                    const existingTime = existingPhase._fieldUpdates?.[field] || 0;
                                    if (incomingTime > existingTime) {
                                        existingPhase[field] = incomingPhase[field];
                                        existingPhase._fieldUpdates = existingPhase._fieldUpdates || {};
                                        existingPhase._fieldUpdates[field] = incomingTime;
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            data._lastUpdated = Math.max(data._lastUpdated || 0, incomingData._lastUpdated || 0);
            renderProjectList();
            updateGantt();
        }

        function broadcastData() {
            data._lastUpdated = Date.now();
            
            // Send to PHP server if connected
            if (eventSource && currentChannel) {
                fetch(`${SYNC_URL}?channel=${currentChannel}&action=push`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                }).catch(() => {});
            }
            
            // Also broadcast locally
            if (broadcastChannel && currentChannel) {
                broadcastChannel.postMessage({
                    type: 'update',
                    data: data,
                    senderId: getOrCreatePeerId()
                });
            }
        }

        function updateSyncStatus(status, text) {
            const el = document.getElementById('syncStatus');
            el.className = 'sync-status ' + status;
            el.textContent = text;
        }

        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                channel: params.get('channel'),
                data: params.get('data')
            };
        }

        function loadFromDataParam(dataParam) {
            try {
                const decompressed = LZString.decompressFromEncodedURIComponent(dataParam);
                if (decompressed) {
                    const parsed = JSON.parse(decompressed);
                    if (parsed.projects) {
                        return parsed;
                    }
                }
            } catch (e) {
                console.error('Error parsing data param:', e);
            }
            return null;
        }

        function generateShareLink() {
            const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(data));
            const url = new URL(window.location.href);
            url.searchParams.set('data', compressed);
            if (currentChannel) {
                url.searchParams.set('channel', currentChannel);
            }
            return url.toString();
        }

        function showAlert(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = `<p style="font-size: 13px;">${message}</p>`;
            document.getElementById('modalFooter').innerHTML = `
                <button class="btn btn-primary" onclick="closeModal()">OK</button>
            `;
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function copyShareLink() {
            const link = generateShareLink();
            navigator.clipboard.writeText(link).then(() => {
                showAlert('Link kopiert', 'Der Link wurde in die Zwischenablage kopiert. Er enth√§lt alle Projektdaten.');
            }).catch(() => {
                const textarea = document.createElement('textarea');
                textarea.value = link;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showAlert('Link kopiert', 'Der Link wurde in die Zwischenablage kopiert.');
            });
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            saveSettings();
        }

        function init() {
            loadSettings();
            
            const today = new Date();
            chartStartDate = new Date(today.getFullYear(), 0, 1);
            chartEndDate = new Date(today.getFullYear(), 11, 31);
            
            document.getElementById('startDate').value = formatDate(chartStartDate);
            document.getElementById('endDate').value = formatDate(chartEndDate);
            
            const params = getURLParams();
            
            if (params.data) {
                const urlData = loadFromDataParam(params.data);
                if (urlData) {
                    data = urlData;
                    ensureIds();
                    applyStoredDateRange();
                }
            }
            
            if (params.channel) {
                initSync(params.channel);
            }
            
            const scrollContainer = document.getElementById('ganttScrollContainer');
            scrollContainer.addEventListener('scroll', updateMinimap);
            
            scrollContainer.addEventListener('wheel', (e) => {
                if (!e.shiftKey) {
                    e.preventDefault();
                    scrollContainer.scrollLeft += e.deltaY;
                }
            }, { passive: false });
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            
            const minimap = document.getElementById('minimap');
            minimap.addEventListener('mousedown', onMinimapMouseDown);
            
            renderProjectList();
            updateGantt();
            
            setTimeout(scrollToToday, 100);
        }

        function applyStoredDateRange() {
            if (data.viewStart && data.viewEnd) {
                chartStartDate = parseDate(data.viewStart);
                chartEndDate = parseDate(data.viewEnd);
                document.getElementById('startDate').value = data.viewStart;
                document.getElementById('endDate').value = data.viewEnd;
            }
        }

        function ensureIds() {
            data.projects.forEach(project => {
                if (!project._id) project._id = generateId('p');
                project._fieldUpdates = project._fieldUpdates || {};
                project.phases.forEach(phase => {
                    if (!phase._id) phase._id = generateId('ph');
                    phase._fieldUpdates = phase._fieldUpdates || {};
                });
            });
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function parseDate(str) {
            return new Date(str + 'T00:00:00');
        }

        function applyDateRange() {
            const startVal = document.getElementById('startDate').value;
            const endVal = document.getElementById('endDate').value;
            
            if (startVal && endVal) {
                chartStartDate = parseDate(startVal);
                chartEndDate = parseDate(endVal);
                data.viewStart = startVal;
                data.viewEnd = endVal;
                updateGantt();
                autoSave();
            }
        }

        function updateZoom() {
            const scrollContainer = document.getElementById('ganttScrollContainer');
            const oldDayWidth = dayWidth;
            
            // Calculate center point before zoom
            const centerX = scrollContainer.scrollLeft + scrollContainer.clientWidth / 2 - 220;
            const centerDay = centerX / oldDayWidth;
            
            dayWidth = parseInt(document.getElementById('zoomSlider').value);
            document.getElementById('zoomValue').textContent = dayWidth + 'px';
            updateGantt();
            
            // Restore center point after zoom
            const newCenterX = centerDay * dayWidth;
            scrollContainer.scrollLeft = newCenterX - scrollContainer.clientWidth / 2 + 220;
            
            saveSettings();
        }

        function updateRowHeight() {
            rowHeight = parseInt(document.getElementById('heightSlider').value);
            document.getElementById('heightValue').textContent = rowHeight + 'px';
            document.documentElement.style.setProperty('--row-height', rowHeight + 'px');
            document.documentElement.style.setProperty('--bar-height', (rowHeight - 13) + 'px');
            updateGantt();
            saveSettings();
        }

        function scrollToToday() {
            const scrollContainer = document.getElementById('ganttScrollContainer');
            const today = new Date();
            const startDate = parseDate(document.getElementById('startDate').value);
            
            if (today >= startDate) {
                const dayOffset = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));
                const scrollPos = (dayOffset * dayWidth) - (scrollContainer.clientWidth / 2) + 220;
                scrollContainer.scrollLeft = Math.max(0, scrollPos);
            }
        }

        function scrollByAmount(amount) {
            const scrollContainer = document.getElementById('ganttScrollContainer');
            scrollContainer.scrollBy({ left: amount, behavior: 'smooth' });
        }

        function updateMinimap() {
            const scrollContainer = document.getElementById('ganttScrollContainer');
            const minimap = document.getElementById('minimap');
            const viewport = document.getElementById('minimapViewport');
            
            if (!viewport) return;
            
            const scrollWidth = scrollContainer.scrollWidth - 220;
            const clientWidth = scrollContainer.clientWidth - 220;
            const scrollLeft = scrollContainer.scrollLeft;
            
            const minimapWidth = minimap.clientWidth;
            const viewportWidth = (clientWidth / scrollWidth) * minimapWidth;
            const viewportLeft = (scrollLeft / scrollWidth) * minimapWidth;
            
            viewport.style.width = Math.max(30, viewportWidth) + 'px';
            viewport.style.left = Math.max(0, viewportLeft) + 'px';
        }

        function onMinimapMouseDown(e) {
            const viewport = document.getElementById('minimapViewport');
            const minimap = document.getElementById('minimap');
            const rect = minimap.getBoundingClientRect();
            const viewportRect = viewport.getBoundingClientRect();
            
            if (e.clientX >= viewportRect.left && e.clientX <= viewportRect.right) {
                minimapDragState = {
                    startX: e.clientX,
                    startScrollLeft: document.getElementById('ganttScrollContainer').scrollLeft
                };
                viewport.style.cursor = 'grabbing';
            } else {
                const clickX = e.clientX - rect.left;
                const ratio = clickX / minimap.clientWidth;
                const scrollContainer = document.getElementById('ganttScrollContainer');
                const scrollWidth = scrollContainer.scrollWidth - 220;
                const clientWidth = scrollContainer.clientWidth - 220;
                scrollContainer.scrollLeft = (ratio * scrollWidth) - (clientWidth / 2);
            }
            
            e.preventDefault();
        }

        function renderProjectList() {
            const container = document.getElementById('projectList');
            
            data.projects.forEach(project => {
                project.phases.sort((a, b) => {
                    return parseDate(a.start) - parseDate(b.start);
                });
            });
            
            container.innerHTML = data.projects.map((project, index) => {
                const isExpanded = expandedProjects.has(project._id);
                return `
                <div class="project-item ${selectedProject?._id === project._id ? 'selected' : ''}" 
                     data-id="${project._id}" 
                     data-index="${index}"
                     draggable="true"
                     ondragstart="onProjectDragStart(event, '${project._id}')"
                     ondragover="onProjectDragOver(event)"
                     ondragleave="onProjectDragLeave(event)"
                     ondrop="onProjectDrop(event, '${project._id}')">
                    <div class="project-header" onclick="toggleProjectAccordion('${project._id}')">
                        <div style="display: flex; align-items: center;">
                            <span class="project-drag-handle" onmousedown="event.stopPropagation()">‚ãÆ‚ãÆ</span>
                            <div>
                                <div class="project-name">
                                    <span class="accordion-toggle ${isExpanded ? 'expanded' : ''}">‚ñ∂</span>
                                    ${statusIcons[project.status] || ''} ${project.name} <span style="color: var(--text-secondary); font-weight: normal;">(${project.phases.length})</span>
                                </div>
                                <div class="project-category">
                                    <span class="project-color-dot" style="background: ${project.color}"></span>
                                    ${project.category || 'Keine Kategorie'}
                                </div>
                            </div>
                        </div>
                        <div class="project-actions">
                            <button class="icon-btn" onclick="event.stopPropagation(); addPhase('${project._id}')">+</button>
                            <button class="icon-btn" onclick="event.stopPropagation(); editProject('${project._id}')">‚úé</button>
                            <button class="icon-btn" onclick="event.stopPropagation(); deleteProject('${project._id}')">üóë</button>
                        </div>
                    </div>
                    <div class="phase-list ${isExpanded ? 'expanded' : ''}" id="phases-${project._id}">
                        ${project.phases.map(phase => `
                            <div class="phase-item" onclick="event.stopPropagation(); selectPhase('${project._id}', '${phase._id}')">
                                <div class="phase-color" style="background: ${phase.color}"></div>
                                <div class="phase-info">
                                    <div class="phase-name">${phase.name}</div>
                                    <div class="phase-dates">${phase.start} ‚Üí ${phase.end}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `}).join('');
        }

        function onProjectDragStart(e, projectId) {
            projectDragState = { projectId };
            e.target.closest('.project-item').classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', projectId);
        }

        function onProjectDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const projectItem = e.target.closest('.project-item');
            if (projectItem && projectDragState && projectItem.dataset.id !== projectDragState.projectId) {
                projectItem.classList.add('drag-over');
            }
        }

        function onProjectDragLeave(e) {
            const projectItem = e.target.closest('.project-item');
            if (projectItem) {
                projectItem.classList.remove('drag-over');
            }
        }

        function onProjectDrop(e, targetProjectId) {
            e.preventDefault();
            const projectItem = e.target.closest('.project-item');
            if (projectItem) {
                projectItem.classList.remove('drag-over');
            }
            
            if (!projectDragState || projectDragState.projectId === targetProjectId) {
                projectDragState = null;
                return;
            }
            
            const sourceIndex = data.projects.findIndex(p => p._id === projectDragState.projectId);
            const targetIndex = data.projects.findIndex(p => p._id === targetProjectId);
            
            if (sourceIndex !== -1 && targetIndex !== -1) {
                const [movedProject] = data.projects.splice(sourceIndex, 1);
                data.projects.splice(targetIndex, 0, movedProject);
                
                renderProjectList();
                updateGantt();
                autoSave();
            }
            
            document.querySelectorAll('.project-item.dragging').forEach(el => el.classList.remove('dragging'));
            projectDragState = null;
        }

        function toggleProjectAccordion(projectId) {
            if (expandedProjects.has(projectId)) {
                expandedProjects.delete(projectId);
            } else {
                expandedProjects.add(projectId);
            }
            selectProject(projectId);
        }

        function updateGantt() {
            const startDate = chartStartDate;
            const endDate = chartEndDate;
            
            renderGanttHeader(startDate, endDate);
            renderGanttBody(startDate, endDate);
            renderMinimap(startDate, endDate);
            updateMinimap();
        }

        function renderGanttHeader(startDate, endDate) {
            const chart = document.getElementById('ganttChart');
            let headerHTML = '<div class="gantt-header">';
            
            let current = new Date(startDate);
            const today = new Date();
            today.setHours(0,0,0,0);
            
            while (current <= endDate) {
                const year = current.getFullYear();
                const month = current.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const startDay = current.getDate();
                const endOfMonth = new Date(year, month + 1, 0);
                const lastDay = endOfMonth > endDate ? endDate.getDate() : daysInMonth;
                const days = lastDay - startDay + 1;
                
                const width = days * dayWidth;
                const monthName = current.toLocaleDateString('de-DE', { month: 'short', year: 'numeric' });
                
                let dayCells = '';
                for (let d = startDay; d <= lastDay; d++) {
                    const cellDate = new Date(year, month, d);
                    const isWeekend = cellDate.getDay() === 0 || cellDate.getDay() === 6;
                    const isToday = cellDate.getTime() === today.getTime();
                    const showDay = dayWidth >= 25 && d % (dayWidth < 35 ? 7 : 1) === 1;
                    
                    dayCells += `<div class="day-cell ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''}" 
                                      style="width: ${dayWidth}px; min-width: ${dayWidth}px;">
                                    ${showDay ? d : ''}
                                 </div>`;
                }
                
                headerHTML += `
                    <div class="gantt-header-month" style="width: ${width}px;">
                        <div class="month-name">${monthName}</div>
                        <div class="day-row">${dayCells}</div>
                    </div>
                `;
                
                current = new Date(year, month + 1, 1);
            }
            
            headerHTML += '</div>';
            chart.innerHTML = headerHTML;
        }

        function renderGanttBody(startDate, endDate) {
            const chart = document.getElementById('ganttChart');
            const labels = document.getElementById('ganttLabels');
            const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            const totalWidth = totalDays * dayWidth;
            
            let labelsHTML = '<div class="gantt-label-header">Projekte</div>';
            data.projects.forEach(project => {
                const statusIcon = statusIcons[project.status] || '';
                const linkIcon = project.link ? `<a href="${project.link}" target="_blank" class="project-link-icon" onclick="event.stopPropagation()" title="${project.link}">üîó</a>` : '';
                const hasDescription = project.description && project.description.trim();
                
                const tooltipHTML = hasDescription 
                    ? `<div class="status-tooltip">${escapeHtml(project.description)}</div>` 
                    : '';
                
                labelsHTML += `
                    <div class="gantt-label-row ${selectedProject?._id === project._id ? 'selected' : ''}" 
                         onclick="selectProject('${project._id}')">
                        <span class="status-icon">${statusIcon}${tooltipHTML}</span>
                        <span class="label-text">${project.name}</span>
                        ${linkIcon}
                        <span class="category-badge" style="background: ${project.color}">${(project.category || '').substring(0,3)}</span>
                    </div>
                `;
            });
            labels.innerHTML = labelsHTML;
            
            let bodyHTML = `<div class="gantt-body" style="width: ${totalWidth}px; height: ${data.projects.length * rowHeight}px;">`;
            
            let current = new Date(startDate);
            while (current <= endDate) {
                const dayOffset = Math.ceil((current - startDate) / (1000 * 60 * 60 * 24));
                bodyHTML += `<div class="gantt-grid-line month" style="left: ${dayOffset * dayWidth}px;"></div>`;
                current.setMonth(current.getMonth() + 1);
                current.setDate(1);
            }
            
            // Collect milestone lines
            const milestoneLines = [];
            data.projects.forEach(project => {
                project.phases.forEach(phase => {
                    if (phase.showStartLine) {
                        const phaseStart = parseDate(phase.start);
                        if (phaseStart >= startDate && phaseStart <= endDate) {
                            const leftDays = Math.ceil((phaseStart - startDate) / (1000 * 60 * 60 * 24));
                            milestoneLines.push({ left: leftDays * dayWidth, type: 'start', color: phase.color });
                        }
                    }
                    if (phase.showEndLine) {
                        const phaseEnd = parseDate(phase.end);
                        if (phaseEnd >= startDate && phaseEnd <= endDate) {
                            const leftDays = Math.ceil((phaseEnd - startDate) / (1000 * 60 * 60 * 24));
                            milestoneLines.push({ left: (leftDays + 1) * dayWidth, type: 'end', color: phase.color });
                        }
                    }
                });
            });
            
            milestoneLines.forEach(line => {
                bodyHTML += `<div class="milestone-line ${line.type}-line" style="left: ${line.left}px; background: ${line.color};"></div>`;
            });
            
            const today = new Date();
            if (today >= startDate && today <= endDate) {
                const todayOffset = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));
                bodyHTML += `
                    <div class="today-line" style="left: ${todayOffset * dayWidth}px;"></div>
                `;
            }
            
            data.projects.forEach((project, idx) => {
                bodyHTML += `<div class="gantt-row" data-project="${project._id}" data-index="${idx}" style="top: ${idx * rowHeight}px; width: ${totalWidth}px; height: ${rowHeight}px; position: absolute;"
                                  onmousedown="startCreate(event, '${project._id}')">`;
                
                const phaseLayouts = calculateSmartOverlaps(project.phases, startDate, endDate);
                
                const barHeight = rowHeight - 13;
                const barTop = 6;
                
                phaseLayouts.forEach(layout => {
                    const phase = layout.phase;
                    const phaseStart = parseDate(phase.start);
                    const phaseEnd = parseDate(phase.end);
                    
                    const clampedStart = phaseStart < startDate ? startDate : phaseStart;
                    const clampedEnd = phaseEnd > endDate ? endDate : phaseEnd;
                    
                    const leftDays = Math.ceil((clampedStart - startDate) / (1000 * 60 * 60 * 24));
                    const durationDays = Math.ceil((clampedEnd - clampedStart) / (1000 * 60 * 60 * 24)) + 1;
                    
                    const left = leftDays * dayWidth;
                    const width = durationDays * dayWidth;
                    const isSelected = selectedPhase?._id === phase._id;
                    
                    let phaseHeight, phaseTop;
                    if (layout.totalSlots === 1) {
                        phaseHeight = barHeight;
                        phaseTop = barTop;
                    } else {
                        const gap = 2;
                        const slotHeight = (barHeight - (layout.totalSlots - 1) * gap) / layout.totalSlots;
                        phaseHeight = slotHeight;
                        phaseTop = barTop + layout.slot * (slotHeight + gap);
                    }
                    
                    const isCompact = width < 100 || phaseHeight < 20;
                    const showSubtitleSeparate = phaseHeight >= 20 && width >= 100;
                    
                    let titleContent = phase.name;
                    if (phase.subtitle && isCompact) {
                        titleContent = `${phase.name} (${phase.subtitle})`;
                    }
                    
                    
                    var linkHTML = phase.link 
                        ? `<a href="${phase.link}" target="_blank" class="phase-bar-link" onclick="event.stopPropagation(); event.preventDefault(); window.open('${phase.link}', '_blank');" title="${phase.link}">üîó</a>` 
                        : '';
                    const subtitleHTML = (showSubtitleSeparate && phase.subtitle) 
                        ? `<div class="phase-bar-subtitle">${phase.subtitle} ${linkHTML}</div>` 
                        : `<div class="phase-bar-subtitle">${linkHTML}</div>`;
                    
                    let fontSize;
                    if (phaseHeight < 16) fontSize = '8px';
                    else if (phaseHeight < 20) fontSize = '9px';
                    else if (rowHeight >= 70) fontSize = '12px';
                    else fontSize = '10px';
                    
                    bodyHTML += `
                        <div class="phase-bar ${isSelected ? 'selected' : ''}" 
                             data-project="${project._id}" 
                             data-phase="${phase._id}"
                             style="left: ${left}px; width: ${width}px; background: ${phase.color}; height: ${phaseHeight}px; top: ${phaseTop}px; font-size: ${fontSize};"
                             onmousedown="startDrag(event, '${project._id}', '${phase._id}', 'move')"
                             onclick="selectPhase('${project._id}', '${phase._id}')">
                            <div class="phase-connector left" style="background: ${phase.color};" onmousedown="event.stopPropagation(); startConnection(event, '${phase._id}', 'left')"></div>
                            <div class="resize-handle left" onmousedown="event.stopPropagation(); startDrag(event, '${project._id}', '${phase._id}', 'resize-left')"></div>
                            <div class="phase-bar-content">
                                <div class="phase-bar-title">${titleContent}</div>
                                ${subtitleHTML}
                            </div>
                            <div class="resize-handle right" onmousedown="event.stopPropagation(); startDrag(event, '${project._id}', '${phase._id}', 'resize-right')"></div>
                            <div class="phase-connector right" style="background: ${phase.color};" onmousedown="event.stopPropagation(); startConnection(event, '${phase._id}', 'right')"></div>
                        </div>
                    `;
                });
                
                bodyHTML += '</div>';
            });
            
            bodyHTML += '</div>';
            chart.innerHTML += bodyHTML;
            
            // Render connections after DOM is ready
            setTimeout(() => {
                const ganttBody = document.querySelector('.gantt-body');
                if (ganttBody && showConnections && data.connections?.length) {
                    const svg = document.createElement('div');
                    svg.innerHTML = renderConnections();
                    if (svg.firstChild) ganttBody.appendChild(svg.firstChild);
                }
            }, 0);
        }

        function calculateSmartOverlaps(phases, startDate, endDate) {
            const visiblePhases = phases
                .map(phase => {
                    const phaseStart = parseDate(phase.start);
                    const phaseEnd = parseDate(phase.end);
                    if (phaseEnd >= startDate && phaseStart <= endDate) {
                        return {
                            phase,
                            start: phaseStart.getTime(),
                            end: phaseEnd.getTime()
                        };
                    }
                    return null;
                })
                .filter(p => p !== null)
                .sort((a, b) => a.start - b.start || a.end - b.end || a.phase._id.localeCompare(b.phase._id));
            
            if (visiblePhases.length === 0) return [];
            
            const result = [];
            
            for (let i = 0; i < visiblePhases.length; i++) {
                const current = visiblePhases[i];
                
                const overlappingIndices = [i];
                for (let j = 0; j < visiblePhases.length; j++) {
                    if (i !== j) {
                        const other = visiblePhases[j];
                        if (current.start <= other.end && current.end >= other.start) {
                            overlappingIndices.push(j);
                        }
                    }
                }
                
                overlappingIndices.sort((a, b) => {
                    const pa = visiblePhases[a], pb = visiblePhases[b];
                    return pa.start - pb.start || pa.end - pb.end || pa.phase._id.localeCompare(pb.phase._id);
                });
                
                const slot = overlappingIndices.indexOf(i);
                const totalSlots = overlappingIndices.length;
                
                result.push({
                    phase: current.phase,
                    slot: slot,
                    totalSlots: totalSlots
                });
            }
            
            return result;
        }

        function renderMinimap(startDate, endDate) {
            const minimap = document.getElementById('minimap');
            const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            const minimapWidth = minimap.clientWidth;
            const scale = minimapWidth / totalDays;
            
            let barsHTML = '';
            data.projects.forEach((project, idx) => {
                const rowHeightMini = 36 / Math.max(data.projects.length, 1);
                project.phases.forEach(phase => {
                    const phaseStart = parseDate(phase.start);
                    const phaseEnd = parseDate(phase.end);
                    
                    if (phaseEnd >= startDate && phaseStart <= endDate) {
                        const leftDays = Math.max(0, Math.ceil((phaseStart - startDate) / (1000 * 60 * 60 * 24)));
                        const durationDays = Math.ceil((phaseEnd - phaseStart) / (1000 * 60 * 60 * 24)) + 1;
                        
                        barsHTML += `<div class="minimap-bar" style="
                            left: ${leftDays * scale}px;
                            width: ${Math.max(2, durationDays * scale)}px;
                            top: ${2 + idx * rowHeightMini}px;
                            background: ${phase.color};
                        "></div>`;
                    }
                });
            });
            
            minimap.innerHTML = barsHTML + '<div class="minimap-viewport" id="minimapViewport"></div>';
        }

        function startCreate(e, projectId) {
            if (e.target.closest('.phase-bar')) return;
            if (e.button !== 0) return;
            
            e.preventDefault();
            
            const row = e.target.closest('.gantt-row');
            const rect = row.getBoundingClientRect();
            const x = e.clientX - rect.left;
            
            const barHeight = rowHeight - 13;
            const barTop = 6;
            
            createState = {
                projectId,
                startX: x,
                currentX: x,
                row,
                preview: null
            };
            
            const preview = document.createElement('div');
            preview.className = 'create-preview';
            preview.style.left = x + 'px';
            preview.style.width = '0px';
            preview.style.height = barHeight + 'px';
            preview.style.top = barTop + 'px';
            row.appendChild(preview);
            createState.preview = preview;
        }

        function onMouseMove(e) {
            if (connectionDragState) {
                connectionDragState.currentX = e.clientX;
                connectionDragState.currentY = e.clientY;
                renderConnectionPreview();
                return;
            }
            
            if (minimapDragState) {
                const deltaX = e.clientX - minimapDragState.startX;
                const minimap = document.getElementById('minimap');
                const scrollContainer = document.getElementById('ganttScrollContainer');
                const scrollWidth = scrollContainer.scrollWidth - 220;
                const minimapWidth = minimap.clientWidth;
                const scrollDelta = (deltaX / minimapWidth) * scrollWidth;
                scrollContainer.scrollLeft = minimapDragState.startScrollLeft + scrollDelta;
                return;
            }
            
            if (dragState) {
                const deltaX = e.clientX - dragState.startX;
                const deltaY = e.clientY - dragState.startY;
                
                // Don't start dragging until threshold is exceeded
                if (!dragState.dragging && Math.abs(deltaX) < DRAG_THRESHOLD && Math.abs(deltaY) < DRAG_THRESHOLD) return;
                if (!dragState.dragging) {
                    dragState.dragging = true;
                    dragState.bar.classList.add('dragging');
                    
                    // Ctrl+drag = copy phase
                    if (e.ctrlKey && dragState.mode === 'move' && !dragState.copied) {
                        const srcProject = data.projects.find(p => p._id === dragState.projectId);
                        const srcPhase = srcProject.phases.find(ph => ph._id === dragState.phaseId);
                        const newPhase = { ...srcPhase, _id: generateId('ph'), _fieldUpdates: {} };
                        srcProject.phases.push(newPhase);
                        dragState.phaseId = newPhase._id;
                        dragState.copied = true;
                    }
                }
                
                const deltaDays = Math.round(deltaX / dayWidth);
                
                // Check if dragging to different project row
                let targetProjectId = dragState.projectId;
                if (dragState.mode === 'move') {
                    const ganttBody = document.querySelector('.gantt-body');
                    const ganttRect = ganttBody.getBoundingClientRect();
                    const relY = e.clientY - ganttRect.top;
                    const rowIdx = Math.floor(relY / rowHeight);
                    if (rowIdx >= 0 && rowIdx < data.projects.length) {
                        targetProjectId = data.projects[rowIdx]._id;
                    }
                }
                
                // Move phase to different project if needed
                if (targetProjectId !== dragState.projectId) {
                    const srcProject = data.projects.find(p => p._id === dragState.projectId);
                    const tgtProject = data.projects.find(p => p._id === targetProjectId);
                    const phaseIdx = srcProject.phases.findIndex(ph => ph._id === dragState.phaseId);
                    if (phaseIdx !== -1) {
                        const [phase] = srcProject.phases.splice(phaseIdx, 1);
                        tgtProject.phases.push(phase);
                        dragState.projectId = targetProjectId;
                    }
                }
                
                const project = data.projects.find(p => p._id === dragState.projectId);
                const phase = project.phases.find(ph => ph._id === dragState.phaseId);
                
                const originalStart = parseDate(dragState.originalStart);
                const originalEnd = parseDate(dragState.originalEnd);
                
                if (dragState.mode === 'move') {
                    const newStart = new Date(originalStart);
                    newStart.setDate(newStart.getDate() + deltaDays);
                    const newEnd = new Date(originalEnd);
                    newEnd.setDate(newEnd.getDate() + deltaDays);
                    
                    phase.start = formatDate(newStart);
                    phase.end = formatDate(newEnd);
                    updateFieldTimestamp(phase, 'start');
                    updateFieldTimestamp(phase, 'end');
                } else if (dragState.mode === 'resize-left') {
                    const newStart = new Date(originalStart);
                    newStart.setDate(newStart.getDate() + deltaDays);
                    if (newStart < originalEnd) {
                        phase.start = formatDate(newStart);
                        updateFieldTimestamp(phase, 'start');
                    }
                } else if (dragState.mode === 'resize-right') {
                    const newEnd = new Date(originalEnd);
                    newEnd.setDate(newEnd.getDate() + deltaDays);
                    if (newEnd > originalStart) {
                        phase.end = formatDate(newEnd);
                        updateFieldTimestamp(phase, 'end');
                    }
                }
                
                updateGantt();
                renderProjectList();
                if (selectedPhase?._id === phase._id) {
                    renderDetailPanel();
                }
                return;
            }
            
            if (createState) {
                const rect = createState.row.getBoundingClientRect();
                const x = e.clientX - rect.left;
                createState.currentX = x;
                
                const left = Math.min(createState.startX, x);
                const width = Math.abs(x - createState.startX);
                
                createState.preview.style.left = left + 'px';
                createState.preview.style.width = width + 'px';
                
                const startDays = Math.floor(left / dayWidth);
                const endDays = Math.floor((left + width) / dayWidth);
                const previewStart = new Date(chartStartDate);
                previewStart.setDate(previewStart.getDate() + startDays);
                const previewEnd = new Date(chartStartDate);
                previewEnd.setDate(previewEnd.getDate() + endDays);
                
                if (width > 50) {
                    createState.preview.textContent = `${formatDate(previewStart)} ‚Üí ${formatDate(previewEnd)}`;
                } else {
                    createState.preview.textContent = '';
                }
            }
        }

        function onMouseUp(e) {
            if (connectionDragState) {
                document.body.style.cursor = '';
                // Find target phase under cursor
                const target = document.elementFromPoint(e.clientX, e.clientY);
                const connector = target?.closest('.phase-connector');
                const bar = target?.closest('.phase-bar');
                
                if (connector && bar) {
                    const toPhase = bar.dataset.phase;
                    const toSide = connector.classList.contains('left') ? 'left' : 'right';
                    
                    // Only connect right->left or left->right, and not to same phase
                    if (toPhase !== connectionDragState.fromPhase && toSide !== connectionDragState.fromSide) {
                        const conn = {
                            _id: generateId('conn'),
                            from: connectionDragState.fromSide === 'right' ? connectionDragState.fromPhase : toPhase,
                            to: connectionDragState.fromSide === 'right' ? toPhase : connectionDragState.fromPhase
                        };
                        if (!data.connections) data.connections = [];
                        // Avoid duplicates
                        if (!data.connections.some(c => c.from === conn.from && c.to === conn.to)) {
                            data.connections.push(conn);
                            autoSave();
                        }
                    }
                }
                
                connectionDragState = null;
                removeConnectionPreview();
                updateGantt();
                return;
            }
            
            if (minimapDragState) {
                minimapDragState = null;
                const viewport = document.getElementById('minimapViewport');
                if (viewport) viewport.style.cursor = 'grab';
                return;
            }
            
            if (dragState) {
                if (dragState.bar) {
                    dragState.bar.classList.remove('dragging');
                }
                dragState = null;
                autoSave();
            }
            
            if (createState) {
                const left = Math.min(createState.startX, createState.currentX);
                const width = Math.abs(createState.currentX - createState.startX);
                
                if (width >= 20) {
                    const startDays = Math.floor(left / dayWidth);
                    const endDays = Math.floor((left + width) / dayWidth);
                    
                    const newStart = new Date(chartStartDate);
                    newStart.setDate(newStart.getDate() + startDays);
                    const newEnd = new Date(chartStartDate);
                    newEnd.setDate(newEnd.getDate() + endDays);
                    
                    const project = data.projects.find(p => p._id === createState.projectId);
                    const randomColor = defaultColors[Math.floor(Math.random() * defaultColors.length)];
                    
                    const newPhase = {
                        _id: generateId('ph'),
                        _fieldUpdates: {},
                        name: 'Neue Phase',
                        subtitle: '',
                        description: '',
                        link: '',
                        start: formatDate(newStart),
                        end: formatDate(newEnd),
                        color: randomColor,
                        showStartLine: false,
                        showEndLine: false
                    };
                    
                    project.phases.push(newPhase);
                    
                    selectedProject = project;
                    selectedPhase = newPhase;
                    
                    renderProjectList();
                    updateGantt();
                    renderDetailPanel();
                    autoSave();
                    
                    if (document.getElementById('detailPanel').classList.contains('hidden')) {
                        toggleDetailPanel();
                    }
                }
                
                if (createState.preview) {
                    createState.preview.remove();
                }
                createState = null;
            }
        }

        function startDrag(e, projectId, phaseId, mode) {
            if (e.target.closest('.phase-bar-link')) {
                return;
            }
            
            if (e.button !== 0) return;
            e.preventDefault();
            e.stopPropagation();
            
            const project = data.projects.find(p => p._id === projectId);
            const phase = project.phases.find(ph => ph._id === phaseId);
            const bar = e.target.closest('.phase-bar');
            
            dragState = {
                projectId,
                phaseId,
                mode,
                startX: e.clientX,
                startY: e.clientY,
                originalStart: phase.start,
                originalEnd: phase.end,
                bar,
                dragging: false,
                copied: false
            };
        }

        function startConnection(e, phaseId, side) {
            e.preventDefault();
            e.stopPropagation();
            
            const bar = e.target.closest('.phase-bar');
            const rect = bar.getBoundingClientRect();
            
            connectionDragState = {
                fromPhase: phaseId,
                fromSide: side,
                startX: side === 'right' ? rect.right : rect.left,
                startY: rect.top + rect.height / 2,
                currentX: e.clientX,
                currentY: e.clientY
            };
            
            document.body.style.cursor = 'crosshair';
        }

        function renderConnectionPreview() {
            removeConnectionPreview();
            if (!connectionDragState) return;
            
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.id = 'connectionPreviewSvg';
            svg.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;';
            
            const {startX, startY, currentX, currentY} = connectionDragState;
            const dx = Math.abs(currentX - startX) / 2;
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', `M${startX},${startY} C${startX + dx},${startY} ${currentX - dx},${currentY} ${currentX},${currentY}`);
            path.setAttribute('class', 'connection-preview');
            
            svg.appendChild(path);
            document.body.appendChild(svg);
        }

        function removeConnectionPreview() {
            document.getElementById('connectionPreviewSvg')?.remove();
        }

        function getPhasePosition(phaseId, side) {
            const bar = document.querySelector(`.phase-bar[data-phase="${phaseId}"]`);
            if (!bar) return null;
            
            const ganttBody = document.querySelector('.gantt-body');
            const bodyRect = ganttBody.getBoundingClientRect();
            const barRect = bar.getBoundingClientRect();
            
            return {
                x: (side === 'right' ? barRect.right : barRect.left) - bodyRect.left,
                y: barRect.top - bodyRect.top + barRect.height / 2
            };
        }

        function renderConnections() {
            if (!showConnections || !data.connections?.length) return '';
            
            const ganttBody = document.querySelector('.gantt-body');
            if (!ganttBody) return '';
            
            let paths = '';
            for (const conn of data.connections) {
                const from = getPhasePosition(conn.from, 'right');
                const to = getPhasePosition(conn.to, 'left');
                if (!from || !to) continue;
                
                const dx = Math.abs(to.x - from.x) / 2;
                paths += `<path class="connection-line" d="M${from.x},${from.y} C${from.x + dx},${from.y} ${to.x - dx},${to.y} ${to.x},${to.y}" data-conn="${conn._id}" onclick="confirmDeleteConnection('${conn._id}')"/>`;
            }
            
            return paths ? `<svg class="connection-svg" style="width:100%;height:100%;overflow:visible;">${paths}</svg>` : '';
        }

        function confirmDeleteConnection(connId) {
            showConfirm('Verbindung l√∂schen', 'M√∂chtest du diese Verbindung wirklich l√∂schen?', () => {
                if (data.connections) {
                    data.connections = data.connections.filter(c => c._id !== connId);
                    autoSave();
                    updateGantt();
                }
                closeModal();
            });
        }

        function toggleConnections() {
            showConnections = document.getElementById('showConnectionsCheckbox').checked;
            updateGantt();
        }

        function selectProject(projectId) {
            selectedProject = data.projects.find(p => p._id === projectId);
            renderProjectList();
            updateGantt();
        }

        function selectPhase(projectId, phaseId) {
            selectedProject = data.projects.find(p => p._id === projectId);
            selectedPhase = selectedProject.phases.find(ph => ph._id === phaseId);
            renderDetailPanel();
            renderProjectList();
            updateGantt();
            if (document.getElementById('detailPanel').classList.contains('hidden')) {
                toggleDetailPanel();
            }
        }

        function toggleDetailPanel() {
            document.getElementById('detailPanel').classList.toggle('hidden');
        }

        function renderDetailPanel() {
            if (!selectedPhase) return;
            
            // Store reference to current phase for updates
            const phaseRef = selectedPhase;
            
            const content = document.getElementById('detailContent');
            content.innerHTML = `
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" class="form-control" value="${phaseRef.name}" 
                           onchange="updatePhaseById('${phaseRef._id}', 'name', this.value)">
                </div>
                <div class="form-group">
                    <label>Untertitel (z.B. Personen)</label>
                    <input type="text" class="form-control" value="${phaseRef.subtitle || ''}" 
                           placeholder="z.B. Max, Anna, Tom"
                           onchange="updatePhaseById('${phaseRef._id}', 'subtitle', this.value)">
                </div>
                <div class="form-group">
                    <label>Startdatum</label>
                    <input type="date" class="form-control" value="${phaseRef.start}" 
                           onblur="updatePhaseById('${phaseRef._id}', 'start', this.value)">
                </div>
                <div class="form-group">
                    <label>Enddatum</label>
                    <input type="date" class="form-control" value="${phaseRef.end}" 
                           onblur="updatePhaseById('${phaseRef._id}', 'end', this.value)">
                </div>
                <div class="form-group">
                    <label>Link</label>
                    <input type="url" class="form-control" value="${phaseRef.link || ''}" 
                           placeholder="https://..."
                           onchange="updatePhaseById('${phaseRef._id}', 'link', this.value)">
                </div>
                <div class="form-group">
                    <label>Beschreibung</label>
                    <textarea class="form-control auto-grow" placeholder="Details zur Phase..." 
                              oninput="this.style.height='';this.style.height=Math.min(this.scrollHeight,200)+'px'"
                              onchange="updatePhaseById('${phaseRef._id}', 'description', this.value)">${phaseRef.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Milestone-Linien</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" ${phaseRef.showStartLine ? 'checked' : ''} 
                                   onchange="updatePhaseById('${phaseRef._id}', 'showStartLine', this.checked)">
                            <span style="color: #4ade80;">‚ñè</span> Startlinie anzeigen
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" ${phaseRef.showEndLine ? 'checked' : ''} 
                                   onchange="updatePhaseById('${phaseRef._id}', 'showEndLine', this.checked)">
                            <span style="color: #f97316;">‚ñè</span> Endlinie anzeigen
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Farbe</label>
                    <div class="color-picker">
                        ${defaultColors.map(color => `
                            <div class="color-option ${phaseRef.color === color ? 'selected' : ''}" 
                                 style="background: ${color}" 
                                 onclick="updatePhaseById('${phaseRef._id}', 'color', '${color}')"></div>
                        `).join('')}
                    </div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <button class="btn btn-success" style="width: 100%; margin-bottom: 8px;" onclick="showSaveDialog()">üíæ Speichern</button>
                    <button class="btn btn-danger" style="width: 100%" onclick="confirmDeletePhase()">üóë Phase l√∂schen</button>
                </div>
            `;
        }

        function confirmDeletePhase() {
            if (!selectedProject || !selectedPhase) return;
            showConfirm('Phase l√∂schen', `M√∂chtest du die Phase "${selectedPhase.name}" wirklich l√∂schen?`, () => {
                selectedProject.phases = selectedProject.phases.filter(ph => ph._id !== selectedPhase._id);
                selectedPhase = null;
                renderProjectList();
                updateGantt();
                autoSave();
                closeModal();
                document.getElementById('detailContent').innerHTML = '<p style="color: var(--text-secondary); text-align: center; margin-top: 50px;">W√§hlen Sie eine Phase aus</p>';
            });
        }

        function showConfirm(title, message, onConfirm) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = `<p style="font-size: 13px;">${message}</p>`;
            document.getElementById('modalFooter').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Abbrechen</button>
                <button class="btn btn-danger" id="modalConfirmBtn">L√∂schen</button>
            `;
            document.getElementById('modalConfirmBtn').onclick = onConfirm;
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function updatePhaseById(phaseId, field, value) {
            for (const project of data.projects) {
                const phase = project.phases.find(p => p._id === phaseId);
                if (phase) {
                    phase[field] = value;
                    updateFieldTimestamp(phase, field);
                    renderProjectList();
                    updateGantt();
                    if (selectedPhase?._id === phaseId) renderDetailPanel();
                    autoSave();
                    return;
                }
            }
        }

        function updateFieldTimestamp(obj, field) {
            obj._fieldUpdates = obj._fieldUpdates || {};
            obj._fieldUpdates[field] = Date.now();
        }

        function updatePhase(field, value) {
            if (!selectedPhase) return;
            selectedPhase[field] = value;
            updateFieldTimestamp(selectedPhase, field);
            renderProjectList();
            updateGantt();
            renderDetailPanel();
            autoSave();
        }

        function deletePhase() {
            confirmDeletePhase();
        }

        function addProject() {
            showModal('Neues Projekt', `
                <div class="form-group">
                    <label>Projektname</label>
                    <input type="text" class="form-control" id="newProjectName" placeholder="z.B. Workflow Automation">
                </div>
                <div class="form-group">
                    <label>Kategorie</label>
                    <input type="text" class="form-control" id="newProjectCategory" placeholder="z.B. Development, Marketing">
                </div>
                <div class="form-group">
                    <label>Beschreibung</label>
                    <textarea class="form-control" id="newProjectDescription" placeholder="Projektbeschreibung (wird beim Hover √ºber Status angezeigt)"></textarea>
                </div>
                <div class="form-group">
                    <label>Link</label>
                    <input type="url" class="form-control" id="newProjectLink" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <div class="status-select" id="newProjectStatusSelect">
                        <div class="status-option selected" onclick="selectStatus('', 'new')">‚Äî</div>
                        <div class="status-option" onclick="selectStatus('ok', 'new')">‚úÖ OK</div>
                        <div class="status-option" onclick="selectStatus('warning', 'new')">‚ö†Ô∏è Warning</div>
                        <div class="status-option" onclick="selectStatus('delay', 'new')">üî¥ Delay</div>
                        <div class="status-option" onclick="selectStatus('complete', 'new')">üèÅ Complete</div>
                    </div>
                    <input type="hidden" id="newProjectStatus" value="">
                </div>
                <div class="form-group">
                    <label>Farbe</label>
                    <div class="color-picker" id="newProjectColorPicker">
                        ${defaultColors.map((color, i) => `
                            <div class="color-option ${i === 0 ? 'selected' : ''}" 
                                 style="background: ${color}" 
                                 onclick="selectProjectColor('${color}', 'new')"></div>
                        `).join('')}
                    </div>
                    <input type="hidden" id="newProjectColor" value="${defaultColors[0]}">
                </div>
            `, () => {
                const name = document.getElementById('newProjectName').value;
                const category = document.getElementById('newProjectCategory').value;
                const description = document.getElementById('newProjectDescription').value;
                const link = document.getElementById('newProjectLink').value;
                const status = document.getElementById('newProjectStatus').value;
                const color = document.getElementById('newProjectColor').value;
                if (name) {
                    const newProject = { 
                        _id: generateId('p'), 
                        _fieldUpdates: {},
                        name, 
                        category, 
                        description,
                        link, 
                        status, 
                        color, 
                        phases: [] 
                    };
                    data.projects.push(newProject);
                    renderProjectList();
                    updateGantt();
                    autoSave();
                    closeModal();
                }
            });
        }

        function selectStatus(status, mode) {
            const selectId = mode === 'new' ? 'newProjectStatusSelect' : 'editProjectStatusSelect';
            const inputId = mode === 'new' ? 'newProjectStatus' : 'editProjectStatus';
            
            document.getElementById(inputId).value = status;
            document.querySelectorAll(`#${selectId} .status-option`).forEach(el => {
                el.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function selectProjectColor(color, mode) {
            const pickerId = mode === 'new' ? 'newProjectColorPicker' : 'editProjectColorPicker';
            const inputId = mode === 'new' ? 'newProjectColor' : 'editProjectColor';
            
            document.getElementById(inputId).value = color;
            document.querySelectorAll(`#${pickerId} .color-option`).forEach(el => {
                el.classList.toggle('selected', el.style.background === color);
            });
        }

        function editProject(projectId) {
            const project = data.projects.find(p => p._id === projectId);
            showModal('Projekt bearbeiten', `
                <div class="form-group">
                    <label>Projektname</label>
                    <input type="text" class="form-control" id="editProjectName" value="${project.name}">
                </div>
                <div class="form-group">
                    <label>Kategorie</label>
                    <input type="text" class="form-control" id="editProjectCategory" value="${project.category || ''}" placeholder="z.B. Development, Marketing">
                </div>
                <div class="form-group">
                    <label>Beschreibung</label>
                    <textarea class="form-control" id="editProjectDescription" placeholder="Projektbeschreibung (wird beim Hover √ºber Status angezeigt)">${project.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Link</label>
                    <input type="url" class="form-control" id="editProjectLink" value="${project.link || ''}" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <div class="status-select" id="editProjectStatusSelect">
                        <div class="status-option ${!project.status ? 'selected' : ''}" onclick="selectStatus('', 'edit')">‚Äî</div>
                        <div class="status-option ${project.status === 'ok' ? 'selected' : ''}" onclick="selectStatus('ok', 'edit')">‚úÖ OK</div>
                        <div class="status-option ${project.status === 'warning' ? 'selected' : ''}" onclick="selectStatus('warning', 'edit')">‚ö†Ô∏è Warning</div>
                        <div class="status-option ${project.status === 'delay' ? 'selected' : ''}" onclick="selectStatus('delay', 'edit')">üî¥ Delay</div>
                        <div class="status-option ${project.status === 'complete' ? 'selected' : ''}" onclick="selectStatus('complete', 'edit')">üèÅ Complete</div>
                    </div>
                    <input type="hidden" id="editProjectStatus" value="${project.status || ''}">
                </div>
                <div class="form-group">
                    <label>Farbe</label>
                    <div class="color-picker" id="editProjectColorPicker">
                        ${defaultColors.map(color => `
                            <div class="color-option ${project.color === color ? 'selected' : ''}" 
                                 style="background: ${color}" 
                                 onclick="selectProjectColor('${color}', 'edit')"></div>
                        `).join('')}
                    </div>
                    <input type="hidden" id="editProjectColor" value="${project.color || defaultColors[0]}">
                </div>
            `, () => {
                project.name = document.getElementById('editProjectName').value;
                project.category = document.getElementById('editProjectCategory').value;
                project.description = document.getElementById('editProjectDescription').value;
                project.link = document.getElementById('editProjectLink').value;
                project.status = document.getElementById('editProjectStatus').value;
                project.color = document.getElementById('editProjectColor').value;
                
                ['name', 'category', 'description', 'link', 'status', 'color'].forEach(field => {
                    updateFieldTimestamp(project, field);
                });
                
                renderProjectList();
                updateGantt();
                autoSave();
                closeModal();
            });
        }

        function deleteProject(projectId) {
            const project = data.projects.find(p => p._id === projectId);
            showConfirm('Projekt l√∂schen', `M√∂chtest du das Projekt "${project.name}" wirklich l√∂schen?`, () => {
                data.projects = data.projects.filter(p => p._id !== projectId);
                renderProjectList();
                updateGantt();
                autoSave();
                closeModal();
            });
        }

        function addPhase(projectId) {
            const project = data.projects.find(p => p._id === projectId);
            const today = new Date();
            const nextMonth = new Date(today);
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            
            showModal('Neue Phase', `
                <div class="form-group">
                    <label>Phasenname</label>
                    <input type="text" class="form-control" id="newPhaseName" placeholder="z.B. Discovery">
                </div>
                <div class="form-group">
                    <label>Untertitel (z.B. Personen)</label>
                    <input type="text" class="form-control" id="newPhaseSubtitle" placeholder="z.B. Max, Anna">
                </div>
                <div class="form-group">
                    <label>Beschreibung</label>
                    <textarea class="form-control large" id="newPhaseDescription" placeholder="Details zur Phase..."></textarea>
                </div>
                <div class="form-group">
                    <label>Link</label>
                    <input type="url" class="form-control" id="newPhaseLink" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>Startdatum</label>
                    <input type="date" class="form-control" id="newPhaseStart" value="${formatDate(today)}">
                </div>
                <div class="form-group">
                    <label>Enddatum</label>
                    <input type="date" class="form-control" id="newPhaseEnd" value="${formatDate(nextMonth)}">
                </div>
                <div class="form-group">
                    <label>Milestone-Linien</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="newPhaseShowStartLine">
                            <span style="color: #4ade80;">‚ñè</span> Startlinie anzeigen
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="newPhaseShowEndLine">
                            <span style="color: #f97316;">‚ñè</span> Endlinie anzeigen
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Farbe</label>
                    <div class="color-picker" id="newPhaseColorPicker">
                        ${defaultColors.map((color, i) => `
                            <div class="color-option ${i === 0 ? 'selected' : ''}" 
                                 style="background: ${color}" 
                                 onclick="selectNewPhaseColor('${color}')"></div>
                        `).join('')}
                    </div>
                    <input type="hidden" id="newPhaseColor" value="${defaultColors[0]}">
                </div>
            `, () => {
                const name = document.getElementById('newPhaseName').value;
                const subtitle = document.getElementById('newPhaseSubtitle').value;
                const description = document.getElementById('newPhaseDescription').value;
                const link = document.getElementById('newPhaseLink').value;
                const start = document.getElementById('newPhaseStart').value;
                const end = document.getElementById('newPhaseEnd').value;
                const color = document.getElementById('newPhaseColor').value;
                const showStartLine = document.getElementById('newPhaseShowStartLine').checked;
                const showEndLine = document.getElementById('newPhaseShowEndLine').checked;
                
                if (name && start && end) {
                    project.phases.push({ 
                        _id: generateId('ph'), 
                        _fieldUpdates: {},
                        name, 
                        subtitle, 
                        description, 
                        link, 
                        start, 
                        end, 
                        color,
                        showStartLine,
                        showEndLine
                    });
                    renderProjectList();
                    updateGantt();
                    autoSave();
                    closeModal();
                }
            });
        }

        function selectNewPhaseColor(color) {
            document.getElementById('newPhaseColor').value = color;
            document.querySelectorAll('#newPhaseColorPicker .color-option').forEach(el => {
                el.classList.toggle('selected', el.style.background === color);
            });
        }

        function showModal(title, content, onSave, saveButtonText = 'Speichern') {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modalFooter').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Abbrechen</button>
                <button class="btn btn-primary" id="modalSaveBtn">${saveButtonText}</button>
            `;
            document.getElementById('modalSaveBtn').onclick = onSave;
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
        }

        function showLoadDialog() {
            const files = getStoredFiles();
            const fileList = Object.values(files).sort((a, b) => b.lastUpdated - a.lastUpdated);
            
            let filesHTML = '';
            if (fileList.length === 0) {
                filesHTML = '<p style="color: var(--text-secondary); text-align: center;">Keine gespeicherten Dateien</p>';
            } else {
                filesHTML = '<div class="file-list">' + fileList.map(file => {
                    const date = new Date(file.lastUpdated);
                    const dateStr = date.toLocaleDateString('de-DE') + ' ' + date.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
                    const projectCount = file.data?.projects?.length || 0;
                    return `
                        <div class="file-item" onclick="selectFileItem(this, '${file.id}')" data-id="${file.id}">
                            <div class="file-info">
                                <h4>${file.title}</h4>
                                <span>${dateStr} ¬∑ ${projectCount} Projekt${projectCount !== 1 ? 'e' : ''}</span>
                            </div>
                            <div class="file-actions">
                                <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); confirmDeleteFile('${file.id}')">üóë</button>
                            </div>
                        </div>
                    `;
                }).join('') + '</div>';
            }
            
            filesHTML += `
                <div class="channel-section">
                    <div class="form-group">
                        <label>Oder neuen Channel erstellen:</label>
                        <div class="channel-input-group">
                            <input type="text" class="form-control" id="channelInput" placeholder="Team-Name eingeben...">
                            <button class="btn btn-success" onclick="joinChannelFromDialog()">Erstellen</button>
                        </div>
                        <small style="color: var(--text-secondary); font-size: 10px;">Ein sicherer Link wird generiert, den du teilen kannst.</small>
                    </div>
                </div>
            `;
            
            showModal('Datei laden', filesHTML, () => {
                const selected = document.querySelector('.file-item.selected');
                if (selected) {
                    const fileId = selected.dataset.id;
                    const file = loadFile(fileId);
                    if (file) {
                        currentFileId = fileId;
                        data = file.data;
                        ensureIds();
                        updateCurrentFileInfo(file.title, file.lastUpdated);
                        renderProjectList();
                        updateGantt();
                        closeModal();
                    }
                }
            }, 'Laden');
        }

        function selectFileItem(element, fileId) {
            document.querySelectorAll('.file-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
        }

        function confirmDeleteFile(fileId) {
            const files = getStoredFiles();
            const file = files[fileId];
            showConfirm('Datei l√∂schen', `M√∂chtest du "${file?.title || 'diese Datei'}" wirklich l√∂schen?`, () => {
                deleteFile(fileId);
                if (currentFileId === fileId) {
                    currentFileId = null;
                    updateCurrentFileInfo(null);
                }
                closeModal();
                showLoadDialog();
            });
        }

        function joinChannelFromDialog() {
            const channelName = document.getElementById('channelInput').value.trim();
            if (channelName) {
                // Generate secure channel ID: name + random token
                const token = Array.from(crypto.getRandomValues(new Uint8Array(12)))
                    .map(b => b.toString(16).padStart(2, '0')).join('');
                const secureChannel = channelName + '-' + token;
                const url = new URL(window.location.href);
                url.searchParams.set('channel', secureChannel);
                
                // Show the full channel ID to user so they can share it
                const shareUrl = url.toString();
                showModal('Channel erstellt!', `
                    <p>Teile diesen Link mit deinem Team:</p>
                    <input type="text" class="form-control" value="${shareUrl}" readonly onclick="this.select()" style="margin: 10px 0;">
                    <p style="font-size: 11px; color: var(--text-secondary);">Der Link wird beim Beitreten in die Zwischenablage kopiert.</p>
                `, () => {
                    navigator.clipboard.writeText(shareUrl).catch(() => {});
                    window.location.href = shareUrl;
                }, 'Beitreten');
            }
        }

        function showSaveDialog() {
            const currentTitle = currentFileId ? (getStoredFiles()[currentFileId]?.title || '') : '';
            
            showModal('Datei speichern', `
                <div class="form-group">
                    <label>Dateiname</label>
                    <input type="text" class="form-control" id="saveFileName" value="${currentTitle}" placeholder="z.B. Meine Roadmap 2024">
                    <small id="saveFileError" style="color: var(--accent); display: none; margin-top: 4px;">Bitte einen Dateinamen eingeben.</small>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="saveAsNew" ${!currentFileId ? 'checked disabled' : ''}>
                        Als neue Datei speichern
                    </label>
                </div>
            `, () => {
                const title = document.getElementById('saveFileName').value.trim();
                const saveAsNew = document.getElementById('saveAsNew').checked;
                
                if (title) {
                    const fileId = (saveAsNew || !currentFileId) ? generateId('file') : currentFileId;
                    currentFileId = fileId;
                    saveFile(fileId, title, data);
                    closeModal();
                    showAlert('Gespeichert', `"${title}" wurde gespeichert.`);
                } else {
                    document.getElementById('saveFileError').style.display = 'block';
                    document.getElementById('saveFileName').focus();
                }
            });
        }

        function exportJSON() {
            const json = JSON.stringify(data, null, 2);
            const shareLink = generateShareLink();
            showModal('JSON Export', `
                <div class="form-group">
                    <label>Teilen-Link (enth√§lt alle Daten)</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" class="form-control" id="exportShareLink" value="${shareLink}" readonly onclick="this.select()">
                        <button class="btn btn-secondary" onclick="navigator.clipboard.writeText(document.getElementById('exportShareLink').value); this.textContent='‚úì'; setTimeout(() => this.textContent='üìã', 1500)">üìã</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>JSON-Daten</label>
                    <div class="json-preview">${escapeHtml(json)}</div>
                </div>
            `, () => {
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'roadmap-' + new Date().toISOString().split('T')[0] + '.json';
                a.click();
                URL.revokeObjectURL(url);
                closeModal();
            });
            document.querySelector('#modalFooter .btn-primary').textContent = 'Herunterladen';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.projects) {
                        data = imported;
                        ensureIds();
                        renderProjectList();
                        updateGantt();
                        autoSave();
                        showAlert('Import erfolgreich', `${data.projects.length} Projekt(e) wurden importiert.`);
                    }
                } catch (err) {
                    showAlert('Import fehlgeschlagen', 'Die Datei konnte nicht gelesen werden: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        init();
    </script>
</body>
</html>